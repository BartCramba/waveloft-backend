AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31

Parameters:
  MyBucketName:
    Type: String
    Default: "wave-loft-audio-bucket"
  # constant partition key for the learning index
  LearningPK:
    Type: String
    Default: DJ

Resources:
  # --------------------------------------------------
  # 1) Cognito Identity Pool + Roles
  # --------------------------------------------------
  MyCognitoIdentityPool:
    Type: AWS::Cognito::IdentityPool
    Properties:
      AllowUnauthenticatedIdentities: true
      IdentityPoolName: "WaveLoftIdentityPool"

  MyUnauthRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: "WaveLoftCognitoUnauthRole"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Federated: "cognito-identity.amazonaws.com"
            Action: sts:AssumeRoleWithWebIdentity
            Condition:
              StringEquals:
                cognito-identity.amazonaws.com:aud: !Ref MyCognitoIdentityPool
              ForAnyValue:StringLike:
                cognito-identity.amazonaws.com:amr: unauthenticated
      Path: "/"
      Policies:
        - PolicyName: "CognitoUnauthS3Policy"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:PutObjectAcl
                Resource: !Sub "arn:aws:s3:::${MyBucketName}/*"

  MyAuthRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: "WaveLoftCognitoAuthRole"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Federated: "cognito-identity.amazonaws.com"
            Action: sts:AssumeRoleWithWebIdentity
            Condition:
              StringEquals:
                cognito-identity.amazonaws.com:aud: !Ref MyCognitoIdentityPool
              ForAnyValue:StringLike:
                cognito-identity.amazonaws.com:amr: authenticated
      Path: "/"

  MyIdentityPoolRoleAttachment:
    Type: AWS::Cognito::IdentityPoolRoleAttachment
    Properties:
      IdentityPoolId: !Ref MyCognitoIdentityPool
      Roles:
        unauthenticated: !GetAtt MyUnauthRole.Arn
        authenticated: !GetAtt MyAuthRole.Arn

  # --------------------------------------------------
  # 2) WaveLoftApi + DynamoDB + S3 Bucket, etc.
  # --------------------------------------------------
  WaveLoftApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: WaveLoftApi
      StageName: Prod
      Cors:
        AllowOrigin: "'*'"
        AllowHeaders: "'Content-Type,Authorization'"
        AllowMethods: "'OPTIONS,GET,POST,PUT,DELETE'"

  ### 1.1 add attributes so CFN knows about them (table is still schemaless at runtime)
  TracksTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: Tracks
      AttributeDefinitions:
        - AttributeName: id            # HASH (already there)
          AttributeType: S
        - AttributeName: pkLearning    # HASH for GSI (constant “DJ”)
          AttributeType: S
        - AttributeName: nextReviewAt  # RANGE for GSI (ISO string)
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: LearningIndex
          KeySchema:
            - AttributeName: pkLearning
              KeyType: HASH
            - AttributeName: nextReviewAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      BillingMode: PAY_PER_REQUEST  # still on-demand

  LogBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: wave-loft-audio-bucket-logs
      LifecycleConfiguration:
        Rules:
          - Id: "TemporaryLogRetention"
            Status: Enabled
            ExpirationInDays: 2
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerEnforced
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  LogBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref LogBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: s3.amazonaws.com
            Action: "s3:PutObject"
            Resource: !Sub "${LogBucket.Arn}/logs/*"
            Condition:
              StringEquals:
                aws:SourceAccount: !Ref AWS::AccountId
              ArnLike:
                aws:SourceArn: !Sub "arn:aws:s3:::${LogBucket}"

  AudioBucket:
    Type: AWS::S3::Bucket
    DependsOn: LogBucket
    Properties:
      BucketName: !Ref MyBucketName
      LifecycleConfiguration:
        Rules:
          - Id: "TransitionFLACtoIntelligentTiering"
            Prefix: "flac/"
            Status: Enabled
            Transitions:
              - StorageClass: INTELLIGENT_TIERING
                TransitionInDays: 30
          - Id: "TransitionFLACtoGlacierDeepArchive"
            Prefix: "flac/"
            Status: Enabled
            Transitions:
              - StorageClass: DEEP_ARCHIVE
                TransitionInDays: 180
      CorsConfiguration:
        CorsRules:
          - AllowedOrigins:
              - "*"
            AllowedMethods:
              - GET
              - PUT
              - POST
            AllowedHeaders:
              - "*"
            ExposedHeaders:
              - ETag
            MaxAge: 3000
      LoggingConfiguration:
        DestinationBucketName: wave-loft-audio-bucket-logs
        LogFilePrefix: "logs/audio/"
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerEnforced
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  # ────────────────────────────────────────────────────────────
  #  NEW 1)  Rich-JSON cold store (TrackDetails table)
  # ────────────────────────────────────────────────────────────
  TrackDetailsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: TrackDetails                # keep it explicit for easy joins
      AttributeDefinitions:
        - AttributeName: trackId
          AttributeType: S
      KeySchema:
        - AttributeName: trackId
          KeyType: HASH
      BillingMode: PAY_PER_REQUEST           # ~0.25 USD / 100 000 items / mo

  # --------------------------------------------------
  # Utility Layers
  # -------------------------------------------------

  UtilsLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      ContentUri: utils
      CompatibleRuntimes:
        - python3.12
      Description: "Layer for CORS utilities + SM-2 latest"

  FFmpegLayer:
    Type: AWS::Lambda::LayerVersion
    Properties:
      Description: "FFmpeg static layer"
      Content:
        # This is wherever you uploaded ffmpeg-layer.zip
        S3Bucket: utilitary-bucket
        S3Key: utils/ffmpeg-layer.zip
      CompatibleRuntimes:
        - python3.12
      LicenseInfo: "MIT"  # or omitted

  # --------------------------------------------------
  # 3) Lambdas
  # --------------------------------------------------
  CreateTrackFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: create_track.lambda_handler
      Runtime: python3.12
      CodeUri: ./tracks
      MemorySize: 2048
      Timeout: 300
      EphemeralStorage:
        Size: 10240
      Role: !GetAtt CreateTrackFunctionRole.Arn
      Policies:
        - DynamoDBCrudPolicy:
            TableName: Tracks
      Events:
        CreateTrackApi:
          Type: Api
          Properties:
            RestApiId: !Ref WaveLoftApi
            Path: /tracks
            Method: POST
      Environment:
        Variables:
          DYNAMODB_TABLE: Tracks
          S3_BUCKET: wave-loft-audio-bucket
          LEARNING_PK: !Ref LearningPK
      Tracing: PassThrough
      Layers:
        - !Ref UtilsLayer

  CreateTrackFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: CreateTrackPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              # CloudWatch Logs
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: "arn:aws:logs:*:*:*"
              # DynamoDB
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:BatchWriteItem
                Resource: !GetAtt TracksTable.Arn
              # S3
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:HeadObject
                Resource: !Sub "arn:aws:s3:::${MyBucketName}/*"

  CreateTrackApiPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref CreateTrackFunction
      Principal: apigateway.amazonaws.com
      SourceArn: arn:aws:execute-api:eu-north-1:739275437165:6mrwx5vn53/*/POST/tracks

  UpdateTrackFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: update_track.lambda_handler
      Runtime: python3.12
      CodeUri: ./tracks
      MemorySize: 128
      Timeout: 3
      Role: !GetAtt UpdateTrackFunctionRole.Arn
      Policies:
        - DynamoDBCrudPolicy:
            TableName: Tracks
      Events:
        UpdateTrackApi:
          Type: Api
          Properties:
            RestApiId: !Ref WaveLoftApi
            Path: /tracks/{id}
            Method: PUT
      Environment:
        Variables:
          DYNAMODB_TABLE: Tracks
          S3_BUCKET: wave-loft-audio-bucket
      Tracing: PassThrough

  UpdateTrackFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: UpdateTrackPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: "arn:aws:logs:*:*:*"
              - Effect: Allow
                Action:
                  - dynamodb:UpdateItem
                Resource: !GetAtt TracksTable.Arn

  UpdateTrackApiPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref UpdateTrackFunction
      Principal: apigateway.amazonaws.com
      SourceArn: arn:aws:execute-api:eu-north-1:739275437165:6mrwx5vn53/*/PUT/tracks/{id}

  ListTracksFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: list_tracks.lambda_handler
      Runtime: python3.12
      CodeUri: ./tracks
      MemorySize: 128
      Timeout: 3
      Role: !GetAtt ListTracksFunctionRole.Arn
      Policies:
        - DynamoDBReadPolicy:
            TableName: Tracks
      Events:
        ListTracksApi:
          Type: Api
          Properties:
            RestApiId: !Ref WaveLoftApi
            Path: /tracks
            Method: GET
      Environment:
        Variables:
          DYNAMODB_TABLE: Tracks
          BUCKET_NAME: wave-loft-audio-bucket
      Layers:
        - !Ref UtilsLayer
      Tracing: PassThrough

  ListTracksFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: ListTracksPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: "arn:aws:logs:*:*:*"
              - Effect: Allow
                Action:
                  - dynamodb:Scan
                  - dynamodb:GetItem
                  - dynamodb:Query
                Resource: !GetAtt TracksTable.Arn

  ListTracksApiPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref ListTracksFunction
      Principal: apigateway.amazonaws.com
      SourceArn: arn:aws:execute-api:eu-north-1:739275437165:6mrwx5vn53/*/GET/tracks

  DeleteTrackFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: delete_track.lambda_handler
      Runtime: python3.12
      CodeUri: ./tracks
      MemorySize: 128
      Timeout: 3
      Role: !GetAtt DeleteTrackFunctionRole.Arn
      Policies:
        - DynamoDBCrudPolicy:
            TableName: Tracks
      Events:
        DeleteTrackApi:
          Type: Api
          Properties:
            RestApiId: !Ref WaveLoftApi
            Path: /tracks/{id}
            Method: DELETE
      Environment:
        Variables:
          DYNAMODB_TABLE: Tracks
          S3_BUCKET: wave-loft-audio-bucket
      Tracing: PassThrough

  DeleteTrackFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: DeleteTrackPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: "arn:aws:logs:*:*:*"
              - Effect: Allow
                Action:
                  - dynamodb:DeleteItem
                Resource: !GetAtt TracksTable.Arn

  DeleteTrackApiPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref DeleteTrackFunction
      Principal: apigateway.amazonaws.com
      SourceArn: arn:aws:execute-api:eu-north-1:739275437165:6mrwx5vn53/*/DELETE/tracks/{id}

  # --------------------------------------------------
  # Get-Due-Tracks  (GET /due)
  # --------------------------------------------------
  GetDueTracksFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: get_due_tracks.lambda_handler
      Runtime: python3.12
      CodeUri: ./tracks
      MemorySize: 256
      Timeout: 5
      Role: !GetAtt GetDueTracksFunctionRole.Arn
      Environment:
        Variables:
          DYNAMODB_TABLE: Tracks
          BUCKET_NAME: wave-loft-audio-bucket
          LEARNING_PK: !Ref LearningPK
      Policies:
        - DynamoDBReadPolicy:
            TableName: Tracks    # lets the Role read/query
        - S3ReadPolicy:
            BucketName: wave-loft-audio-bucket  # for presigned URL
      Events:
        GetDueTracksApi:
          Type: Api
          Properties:
            RestApiId: !Ref WaveLoftApi
            Path: /due
            Method: GET
      Tracing: PassThrough
      Layers:
        - !Ref UtilsLayer

  GetDueTracksFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: GetDueTracksPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              # CloudWatch Logs
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: "arn:aws:logs:*:*:*"
              # DynamoDB read
              # 2) Query the table *and* the index
              - Effect: Allow
                Action: dynamodb:Query
                Resource:
                  - !GetAtt TracksTable.Arn
                  - !Sub "${TracksTable.Arn}/index/LearningIndex"
              - Effect: Allow
                Action:
                  - dynamodb:Query
                  - dynamodb:GetItem
                Resource: !GetAtt TracksTable.Arn
              # S3 presign requires GetObject permission
              - Effect: Allow
                Action:
                  - s3:GetObject
                Resource: !Sub "arn:aws:s3:::${MyBucketName}/*"

  GetDueTracksApiPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref GetDueTracksFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WaveLoftApi}/*/GET/due"

  # --------------------------------------------------
  # Update-Stats  (POST /grade)
  # --------------------------------------------------
  UpdateStatsFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: update_stats.lambda_handler
      Runtime: python3.12
      CodeUri: ./tracks
      MemorySize: 256
      Timeout: 5
      Role: !GetAtt UpdateStatsFunctionRole.Arn
      Environment:
        Variables:
          DYNAMODB_TABLE: Tracks
          LEARNING_PK: !Ref LearningPK
      Policies:
        - DynamoDBCrudPolicy:
            TableName: Tracks    # need GetItem + UpdateItem
      Events:
        UpdateStatsApi:
          Type: Api
          Properties:
            RestApiId: !Ref WaveLoftApi
            Path: /grade
            Method: POST
      Tracing: PassThrough
      Layers:
        - !Ref UtilsLayer

  UpdateStatsFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: UpdateStatsPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              # CloudWatch Logs
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: "arn:aws:logs:*:*:*"
              # DynamoDB read-write
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:UpdateItem
                Resource: !GetAtt TracksTable.Arn

  UpdateStatsApiPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref UpdateStatsFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WaveLoftApi}/*/POST/grade"


  UploadAudioFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: upload_audio.lambda_handler
      Runtime: python3.12
      CodeUri: ./audio
      MemorySize: 128
      Timeout: 3
      Role: !GetAtt UploadFunctionRole.Arn
      Environment:
        Variables:
          BUCKET_NAME: wave-loft-audio-bucket
      Policies:
        - S3WritePolicy:
            BucketName: wave-loft-audio-bucket
      Events:
        UploadAudioApi:
          Type: Api
          Properties:
            RestApiId: !Ref WaveLoftApi
            Path: /upload
            Method: POST

  UploadFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: S3WriteAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutObject
                Resource: !Sub "arn:aws:s3:::${MyBucketName}/*"

  GeneratePresignedUrlUploadFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: generate_presigned_url_upload.lambda_handler
      Runtime: python3.12
      CodeUri: ./audio
      MemorySize: 512
      Timeout: 60
      Role: !GetAtt GeneratePresignedUrlUploadFunctionRole.Arn
      Environment:
        Variables:
          BUCKET_NAME: wave-loft-audio-bucket
      Policies:
        - S3WritePolicy:
            BucketName: wave-loft-audio-bucket
      Layers:
        - !Ref UtilsLayer
      Events:
        GeneratePresignedUrlUploadApi:
          Type: Api
          Properties:
            RestApiId: !Ref WaveLoftApi
            Path: /upload/presigned
            Method: POST

  GeneratePresignedUrlUploadFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: GeneratePresignedUrlUploadPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              # CloudWatch Logs
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: arn:aws:logs:*:*:*
              # S3
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:GetObject
                Resource: !Sub "arn:aws:s3:::${MyBucketName}/*"

  GeneratePresignedUrlDownloadFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: generate_presigned_url_download.lambda_handler
      Runtime: python3.12
      CodeUri: ./audio
      MemorySize: 512
      Timeout: 60
      Role: !GetAtt GeneratePresignedUrlDownloadFunctionRole.Arn
      Environment:
        Variables:
          BUCKET_NAME: wave-loft-audio-bucket
          DYNAMODB_TABLE: Tracks
      Policies:
        - S3ReadPolicy:
            BucketName: wave-loft-audio-bucket
        - DynamoDBReadPolicy:
            TableName: Tracks
      Layers:
        - !Ref UtilsLayer
      Events:
        GeneratePresignedUrlDownloadApi:
          Type: Api
          Properties:
            RestApiId: !Ref WaveLoftApi
            Path: /download/presigned
            Method: GET

  GeneratePresignedUrlDownloadFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: GeneratePresignedUrlDownloadPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              # CloudWatch Logs
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: arn:aws:logs:*:*:*
              # S3
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:ListBucket
                Resource:
                  - !Sub "arn:aws:s3:::${MyBucketName}"
                  - !Sub "arn:aws:s3:::${MyBucketName}/*"
              # DynamoDB
              - Effect: Allow
                Action:
                  - dynamodb:Scan
                  - dynamodb:GetItem
                  - dynamodb:Query
                Resource: !GetAtt TracksTable.Arn

    # --------------------------------------------------
  # 4) TranscodeFlacFunction
  # --------------------------------------------------
  TranscodeFlacFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: transcode.flac_to_mp3_handler
      Runtime: python3.12
      CodeUri: ./transcode
      MemorySize: 2048
      Timeout: 300
      Layers:
        - !Ref FFmpegLayer
      Events:
        FlacUpload:
          Type: S3
          Properties:
            Bucket: !Ref AudioBucket
            Events:
              - s3:ObjectCreated:*
            Filter:
              S3Key:
                Rules:
                  - Name: prefix
                    Value: flac/
      Environment:
        Variables:
          BUCKET_NAME: !Ref MyBucketName
          DYNAMODB_TABLE: Tracks
      Policies:
        - S3ReadPolicy:
            BucketName: !Ref MyBucketName
        - S3WritePolicy:
            BucketName: !Ref MyBucketName
        - Statement:
            - Effect: Allow
              Action:
                - logs:CreateLogGroup
                - logs:CreateLogStream
                - logs:PutLogEvents
              Resource: "arn:aws:logs:*:*:*"
        - Statement:
            - Effect: Allow
              Action:
                - dynamodb:UpdateItem
              Resource: !GetAtt TracksTable.Arn

  TranscodeFlacPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: "lambda:InvokeFunction"
      FunctionName: !GetAtt TranscodeFlacFunction.Arn
      Principal: "s3.amazonaws.com"
      SourceArn: !Sub "arn:aws:s3:::${AudioBucket}"


  # 1) The new function resource
  CreateTrackItemFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: create_track_item.lambda_handler
      Runtime: python3.12
      CodeUri: ./tracks  # or a subfolder if you want, e.g. ./track_items
      MemorySize: 128
      Timeout: 3
      Role: !GetAtt CreateTrackItemFunctionRole.Arn
      Events:
        CreateTrackItemApi:
          Type: Api
          Properties:
            RestApiId: !Ref WaveLoftApi
            Path: /trackItems
            Method: POST
      Environment:
        Variables:
          DYNAMODB_TABLE: Tracks  # your existing table name
      Tracing: PassThrough

  # 2) The function's Role
  CreateTrackItemFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: CreateTrackItemPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              # CloudWatch logs
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: "arn:aws:logs:*:*:*"

              # DynamoDB: we just need putItem (and maybe getItem) on the Tracks table
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:GetItem
                Resource: !GetAtt TracksTable.Arn

  # 3) The permission from API Gateway
  CreateTrackItemApiPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref CreateTrackItemFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WaveLoftApi}/*/POST/trackItems"

    # ────────────────────────────────────────────────────────────
  # DetailsEnricher Lambda – let SAM create the IAM role
  # ────────────────────────────────────────────────────────────
  DetailsEnricherFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./tracks
      Handler: details_enricher.lambda_handler
      Runtime: python3.12
      MemorySize: 256
      Timeout: 30

      Policies:
        - S3ReadPolicy:          # GetObject on the whole bucket
            BucketName: !Ref MyBucketName
        - DynamoDBCrudPolicy:
            TableName: !Ref TrackDetailsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref TracksTable

      Events:
        SidecarUploaded:
          Type: S3
          Properties:
            Bucket: !Ref AudioBucket
            Events: s3:ObjectCreated:*
            Filter:
              S3Key:
                Rules:
                  - Name: prefix
                    Value: meta/

      Environment:
        Variables:
          TRACKS_TABLE:  !Ref TracksTable
          DETAILS_TABLE: !Ref TrackDetailsTable
      Layers:
        - !Ref UtilsLayer
      Tracing: PassThrough

  # S3 → Lambda invoke permission (SAM usually creates it automatically,
  # but adding it explicitly makes single-file reuse easier)
  DetailsEnricherPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt DetailsEnricherFunction.Arn
      Principal: s3.amazonaws.com
      SourceArn: !Sub "arn:aws:s3:::${AudioBucket}"

  LookupTrackIdFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: lookup_by_filename.lambda_handler
      Runtime: python3.12
      CodeUri: ./tracks
      MemorySize: 128
      Timeout: 3
      Policies:
        - DynamoDBReadPolicy:
            TableName: Tracks
      Events:
        LookupTrackIdApi:
          Type: Api
          Properties:
            RestApiId: !Ref WaveLoftApi
            Path: /lookup
            Method: GET
      Environment:
        Variables:
          DYNAMODB_TABLE: Tracks

Outputs:
  CognitoIdentityPoolId:
    Description: "Use this in your front-end code for fromCognitoIdentityPool(...)"
    Value: !Ref MyCognitoIdentityPool

  S3BucketName:
    Description: "Wave Loft Audio Bucket"
    Value: !Ref AudioBucket

  WaveLoftApiUrl:
    Description: "API Gateway endpoint"
    Value: !Sub "https://${WaveLoftApi}.execute-api.${AWS::Region}.amazonaws.com/Prod"
